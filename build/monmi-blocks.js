(()=>{"use strict";const e=window.wc.wcBlocksRegistry,t=window.wc.wcSettings,n=window.wp.element,o=window.wp.i18n,r=window.wp.htmlEntities,s=(e,...t)=>"function"==typeof e?e(...t):void 0,a=(0,t.getSetting)("monmi_pay_data",{}),i=a.gatewayId||"monmi_pay",c=a.supports||{features:["products"]},u=(0,r.decodeEntities)(a.title||(0,o.__)("Monmi Pay","monmi-pay")),m=a.i18n||{},l=e=>{const t=e.eventRegistration||{},r=e.emitResponse||{},c=e.billingData||e.billing||{},u=e.shippingData||e.shipping||{},l=!!e.isEditor,y={token:a.session&&a.session.token?a.session.token:"",code:a.session&&a.session.code?a.session.code:"",status:a.session&&a.session.status?a.session.status:"",payload:a.session&&a.session.data?a.session.data:null},[d,p]=(0,n.useState)(y),f=(0,n.useRef)(d),g=e=>{f.current={...f.current,...e},p({...f.current})},w=(0,n.useRef)(c),k=(0,n.useRef)(u),h=(0,n.useRef)(null),_=(0,n.useRef)(null),[P,E]=(0,n.useState)(""),[b,M]=(0,n.useState)("");(0,n.useEffect)(()=>{w.current=c||{}},[c]),(0,n.useEffect)(()=>{k.current=u||{}},[u]);const v=(0,n.useMemo)(()=>"monmi-pay-block-"+Math.random().toString(36).slice(2),[]),S=()=>{_.current&&"function"==typeof _.current.destroy&&_.current.destroy(),_.current=null,h.current&&(h.current.innerHTML="")},R=()=>{if(!h.current||!f.current.token)return;const e=window.MonmiPay;if(void 0===e)return void E(m.sdkMissing||(0,o.__)("Payment library still loading. Please wait a moment and try again.","monmi-pay"));if(_.current&&"function"==typeof _.current.update)return void _.current.update({token:f.current.token});const t="#"+v;"function"!=typeof e.render?"function"!=typeof e.init?window.console&&"function"==typeof window.console.warn&&window.console.warn("Monmi Pay SDK does not expose a supported render/init API."):_.current=e.init({token:f.current.token,mount:t}):_.current=e.render({token:f.current.token,element:t})},D=(e,t)=>{if(f.current.token)return Promise.resolve();M(m.creatingPayment||(0,o.__)("Creating your Monmi payment session...","monmi-pay")),E("");const n={billing:e||{},shipping:t||{}};return window.fetch(a.createPaymentUrl,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":a.nonce},credentials:"same-origin",body:JSON.stringify(n)}).then(e=>e.json().catch(()=>({})).then(t=>{if(!e.ok){const e=t&&t.message?t.message:m.genericError?m.genericError:(0,o.__)("Unable to process your payment at this time. Please try again.","monmi-pay");throw new Error(e)}const n=t&&t.token?t.token:"",r=t&&t.status?t.status:"",s=t&&t.payment?t.payment:null;if(!n)throw new Error(m.genericError?m.genericError:(0,o.__)("Unable to process your payment at this time. Please try again.","monmi-pay"));const a={token:n,status:r};s&&s.code&&!f.current.code&&(a.code=s.code),s&&(a.payload=s),g(a),M(""),R()})).catch(e=>{S(),g({token:"",status:"",payload:null}),M("");const t=e&&e.message?e.message:m.genericError?m.genericError:(0,o.__)("Unable to process your payment at this time. Please try again.","monmi-pay");throw E(t),e})};return(0,n.useEffect)(()=>{d.token?R():S()},[d.token,v]),(0,n.useEffect)(()=>{const e=s(t.onPaymentMethodSelected,()=>{D(w.current,k.current).catch(()=>{})}),n=s(t.onPaymentMethodDeselected,()=>{S()});return()=>{s(e),s(n)}},[t]),(0,n.useEffect)(()=>{l&&D(w.current,k.current).catch(()=>{})},[l]),(0,n.useEffect)(()=>{const e=s(t.onPaymentProcessing,()=>(s(r.startedProcessingPayment),D(w.current,k.current).then(()=>(()=>{const e=_.current;return e&&"function"==typeof e.confirm?Promise.resolve(e.confirm()).then(e=>{if(e&&e.error)throw e.error;const t={};return e&&e.token&&(t.token=e.token),e&&e.code&&(t.code=e.code),e&&(e.payment||e.payload)&&(t.payload=e.payment||e.payload),Object.keys(t).length&&g(t),e}):Promise.resolve(null)})()).then(()=>{g({status:"success"}),E(""),M(m.paymentSuccess?m.paymentSuccess:(0,o.__)("Payment authorised. Finalising your order...","monmi-pay"));const e=(e=>{const t=e.payload,n={token:e.token||"",code:e.code||"",status:e.status||""};return t&&(n.payload=t),n.monmi_payment_token=n.token,n.monmi_payment_code=n.code,n.monmi_payment_status=n.status,t&&(n.monmi_payment_payload=t),n})(f.current);return s(r.finishedProcessingPayment,{status:"success",paymentMethodData:e}),{type:"success",meta:{paymentMethodData:e}}}).catch(e=>{const t=e&&e.message?e.message:m.paymentFailed?m.paymentFailed:(0,o.__)("Monmi could not authorise your payment. Please try again.","monmi-pay");return E(t),M(""),g({status:"failed"}),s(r.finishedProcessingPayment,{status:"error",message:t}),{type:"error",message:t}})));return()=>{s(e)}},[t,r]),(0,n.useEffect)(()=>{const e=s(t.onCheckoutValidation,e=>{e&&"function"==typeof e.setValidationError&&(f.current.token||e.setValidationError(i,{message:m.genericError?m.genericError:(0,o.__)("Unable to process your payment at this time. Please try again.","monmi-pay")}))});return()=>{s(e)}},[t]),(0,n.createElement)(n.Fragment,null,(0,n.createElement)("div",{className:"monmi-pay-block__container"},(0,n.createElement)("div",{className:"monmi-pay-block__sdk-target",ref:h,id:v}),b?(0,n.createElement)("div",{className:"wc-block-components-notice-banner wc-block-components-notice-banner--info",role:"status"},b):null,P?(0,n.createElement)("div",{className:"wc-block-components-notice-banner wc-block-components-notice-banner--error",role:"alert"},P):null))};i&&(0,e.registerPaymentMethod)({name:i,label:()=>(0,n.createElement)("span",null,u),canMakePayment:()=>!0,content:l,edit:l,supports:c})})();